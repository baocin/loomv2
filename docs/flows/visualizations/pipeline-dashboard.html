<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loom v2 Pipeline Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }
        
        .pipeline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pipeline-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #ccc;
        }
        
        .pipeline-card.critical {
            border-left-color: #FF5252;
        }
        
        .pipeline-card.high {
            border-left-color: #FF9800;
        }
        
        .pipeline-card.medium {
            border-left-color: #4CAF50;
        }
        
        .pipeline-card.low {
            border-left-color: #2196F3;
        }
        
        .pipeline-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .pipeline-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .pipeline-models {
            margin-top: 10px;
            font-size: 12px;
            color: #999;
        }
        
        #network-graph {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            height: 600px;
            position: relative;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .node text {
            font-size: 12px;
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 1px;
        }
        
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 10px;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Loom v2 Pipeline Dashboard</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Pipelines</h3>
                <div class="stat-value">11</div>
            </div>
            <div class="stat-card">
                <h3>Kafka Topics</h3>
                <div class="stat-value">63</div>
            </div>
            <div class="stat-card">
                <h3>AI Models</h3>
                <div class="stat-value">8</div>
            </div>
            <div class="stat-card">
                <h3>Total Events/sec</h3>
                <div class="stat-value">62.2</div>
            </div>
        </div>
        
        <h2>Pipeline Overview</h2>
        <div class="pipeline-grid" id="pipeline-grid">
            <!-- Pipeline cards will be inserted here -->
        </div>
        
        <h2>Pipeline Network Graph</h2>
        <div id="network-graph">
            <svg id="graph-svg"></svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF5252"></div>
                <span>Critical</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF9800"></div>
                <span>High</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4CAF50"></div>
                <span>Medium</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2196F3"></div>
                <span>Low</span>
            </div>
        </div>
        
        <div class="tooltip"></div>
    </div>
    
    <script>
        // Pipeline data (this would normally be loaded from the JSON file)
        const pipelines = {
            "audio_processing": {
                "name": "Audio Processing",
                "priority": "critical",
                "stages": 4,
                "models": ["Silero VAD", "NVIDIA Parakeet-TDT"],
                "input_rate": "10 events/sec",
                "latency_target": "< 3s"
            },
            "camera_vision": {
                "name": "Camera Vision",
                "priority": "critical",
                "stages": 6,
                "models": ["Moondream", "MediaPipe", "ORB-SLAM3"],
                "input_rate": "0.03 events/sec",
                "latency_target": "< 10s"
            },
            "screenshot_ocr": {
                "name": "Screenshot OCR",
                "priority": "high",
                "stages": 4,
                "models": ["Tesseract OCR"],
                "input_rate": "0.1 events/sec",
                "latency_target": "< 5s"
            },
            "location_enrichment": {
                "name": "Location Enrichment",
                "priority": "high",
                "stages": 4,
                "models": ["PostGIS", "Nominatim", "Foursquare"],
                "input_rate": "0.1 events/sec",
                "latency_target": "< 5s"
            },
            "app_lifecycle": {
                "name": "App Lifecycle",
                "priority": "high",
                "stages": 2,
                "models": [],
                "input_rate": "2 events/sec",
                "latency_target": "< 1s"
            },
            "motion_classification": {
                "name": "Motion Classification",
                "priority": "medium",
                "stages": 4,
                "models": ["TensorFlow Activity Recognition"],
                "input_rate": "50 events/sec",
                "latency_target": "< 1s"
            },
            "email_processing": {
                "name": "Email Processing",
                "priority": "medium",
                "stages": 3,
                "models": ["Sentence Transformers"],
                "input_rate": "0.01 events/sec",
                "latency_target": "< 30s"
            },
            "calendar_processing": {
                "name": "Calendar Processing",
                "priority": "medium",
                "stages": 3,
                "models": ["Sentence Transformers"],
                "input_rate": "0.001 events/sec",
                "latency_target": "< 30s"
            },
            "power_state": {
                "name": "Power State",
                "priority": "medium",
                "stages": 3,
                "models": [],
                "input_rate": "0.1 events/sec",
                "latency_target": "< 2s"
            },
            "hackernews_processing": {
                "name": "HackerNews Processing",
                "priority": "low",
                "stages": 3,
                "models": ["Sentence Transformers"],
                "input_rate": "0.0001 events/sec",
                "latency_target": "< 5min"
            },
            "network_events": {
                "name": "Network Events",
                "priority": "low",
                "stages": 3,
                "models": [],
                "input_rate": "0.01 events/sec",
                "latency_target": "< 10s"
            }
        };
        
        // Colors by priority
        const colors = {
            critical: '#FF5252',
            high: '#FF9800',
            medium: '#4CAF50',
            low: '#2196F3'
        };
        
        // Create pipeline cards
        function createPipelineCards() {
            const grid = document.getElementById('pipeline-grid');
            
            // Sort by priority
            const priorityOrder = ['critical', 'high', 'medium', 'low'];
            const sortedPipelines = Object.entries(pipelines).sort((a, b) => {
                return priorityOrder.indexOf(a[1].priority) - priorityOrder.indexOf(b[1].priority);
            });
            
            sortedPipelines.forEach(([key, pipeline]) => {
                const card = document.createElement('div');
                card.className = `pipeline-card ${pipeline.priority}`;
                
                const modelsHtml = pipeline.models.length > 0 
                    ? `<div class="pipeline-models">Models: ${pipeline.models.join(', ')}</div>`
                    : '';
                
                card.innerHTML = `
                    <h3>${pipeline.name}</h3>
                    <div class="pipeline-stats">
                        <span>${pipeline.stages} stages</span>
                        <span>${pipeline.input_rate}</span>
                        <span>${pipeline.latency_target}</span>
                    </div>
                    ${modelsHtml}
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Create network graph
        function createNetworkGraph() {
            const width = document.getElementById('network-graph').clientWidth - 40;
            const height = 560;
            
            const svg = d3.select('#graph-svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create nodes from pipeline data
            const nodes = Object.entries(pipelines).map(([id, data]) => ({
                id: id,
                name: data.name,
                priority: data.priority,
                stages: data.stages
            }));
            
            // Create sample links (in real implementation, these would come from topic connections)
            const links = [
                {source: 'audio_processing', target: 'motion_classification'},
                {source: 'location_enrichment', target: 'app_lifecycle'},
                {source: 'screenshot_ocr', target: 'email_processing'},
                {source: 'camera_vision', target: 'location_enrichment'},
                {source: 'power_state', target: 'network_events'}
            ];
            
            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));
            
            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link');
            
            // Create nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .enter().append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add circles to nodes
            node.append('circle')
                .attr('r', d => 20 + d.stages * 2)
                .attr('fill', d => colors[d.priority]);
            
            // Add labels to nodes
            node.append('text')
                .text(d => d.name)
                .attr('x', 0)
                .attr('y', 35)
                .attr('text-anchor', 'middle')
                .style('font-size', '11px');
            
            // Tooltip
            const tooltip = d3.select('.tooltip');
            
            node.on('mouseover', (event, d) => {
                const pipeline = pipelines[d.id];
                tooltip.html(`
                    <strong>${d.name}</strong><br>
                    Priority: ${d.priority}<br>
                    Stages: ${d.stages}<br>
                    Rate: ${pipeline.input_rate}<br>
                    Latency: ${pipeline.latency_target}
                `)
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', () => {
                tooltip.style('opacity', 0);
            });
            
            // Update positions on tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('transform', d => `translate(${d.x},${d.y})`);
            });
            
            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }
        
        // Initialize
        createPipelineCards();
        createNetworkGraph();
    </script>
</body>
</html>